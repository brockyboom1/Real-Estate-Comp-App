<!DOCTYPE html>
<html>
<head>
    <title>Real Estate Agency Map</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            background: #f5f7fa;
        }
        
        .header {
            background-color: #4c6ef5;
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
        }
        
        .header p {
            margin: 8px 0 0;
            font-size: 16px;
            opacity: 0.9;
        }

        #map {
            height: 60vh;
            width: 100%;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .agency-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            padding: 20px;
            max-width: 2000px;
            margin: 0 auto;
        }

        .agency-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            padding: 30px;
            transition: transform 0.2s;
            height: fit-content;
        }

        .agency-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .agency-name {
            font-size: 26px;
            color: #4c6ef5;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .agency-address {
            color: #555;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .agency-phone {
            color: #4c6ef5;
            font-size: 16px;
            margin-bottom: 25px;
        }

        .agency-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .stat-item:hover {
            transform: translateY(-3px);
        }

        .stat-label {
            color: #555;
            font-size: 15px;
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            color: #4c6ef5;
            font-weight: bold;
            font-size: 28px;
        }

        .reviews-section {
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
        }

        .rating-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .stars {
            color: #ffd700;
            font-size: 18px;
        }

        .review-count {
            color: #666;
            font-size: 14px;
        }

        .review-toggle {
            background: #f0f0f0;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .review-toggle:hover {
            background: #e0e0e0;
        }

        .reviews-list {
            font-size: 14px;
            color: #666;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .reviews-list li {
            margin-bottom: 5px;
            padding: 5px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .good-review {
            border-left: 3px solid #4caf50;
        }

        .bad-review {
            border-left: 3px solid #f44336;
        }

        .map-container {
            position: relative;
            height: 400px;
        }

        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            display: flex;
            gap: 10px;
        }

        .map-button {
            background: white;
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .map-button:hover {
            background: #f0f0f0;
        }

        .filter-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .suburb-select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
            cursor: pointer;
        }

        .suburb-select:hover {
            border-color: #4c6ef5;
        }

        .suburb-select:focus {
            outline: none;
            border-color: #4c6ef5;
            box-shadow: 0 0 0 2px rgba(76,110,245,0.1);
        }

        .staff-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px solid #eef1f5;
        }

        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .staff-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.2s;
        }

        .staff-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .staff-name {
            font-weight: bold;
            color: #4c6ef5;
        }

        .staff-position {
            font-size: 12px;
            color: #888;
            margin: 3px 0;
        }

        .staff-phone {
            color: #4c6ef5;
            font-size: 12px;
        }

        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .staff-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .staff-modal-header {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 1002;
        }

        .staff-modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #666;
            padding: 0.5rem;
            line-height: 1;
        }

        .staff-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding-top: 0.5rem;
        }

        .staff-modal-photo {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 1rem;
            border: 4px solid #f3f4f6;
        }

        .staff-modal-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .staff-modal-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .staff-modal-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .staff-modal-position {
            font-size: 1.1rem;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }

        .staff-modal-phone {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
            max-width: 350px;
            margin-top: 0.5rem;
        }

        .performance-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .performance-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-color: #4c6ef5;
        }

        .performance-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e40af;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .performance-label {
            font-size: 0.875rem;
            color: #475569;
            text-align: center;
            font-weight: 500;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .compare-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #4c6ef5;
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(76,110,245,0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            cursor: pointer;
            border: none;
        }

        .compare-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76,110,245,0.4);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            position: relative;
            background: white;
            width: 90%;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-close:hover {
            color: #000;
        }

        .compare-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .agent-selector {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
        }

        .agent-selector h3 {
            margin-bottom: 1rem;
            color: #1f2937;
        }

        .agent-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .agent-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-item:hover {
            background: #f3f4f6;
        }

        .agent-item.selected {
            background: #e5e7eb;
            border-color: #4c6ef5;
        }

        .agent-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 1rem;
            object-fit: cover;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-weight: 500;
            color: #1f2937;
        }

        .agent-details {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .comparison-stats {
            margin-top: 2rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        .comparison-stats h3 {
            margin-bottom: 1rem;
            color: #1f2937;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-title {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .difference-indicator {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .difference-value {
            margin-left: 0.5rem;
            font-weight: 500;
        }

        .better {
            color: #059669;
        }

        .worse {
            color: #dc2626;
        }

        .better-performer {
            border: 2px solid #059669;
            background: #f0fdf4;
        }

        .search-container {
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .search-input:focus {
            outline: none;
            border-color: #4c6ef5;
            box-shadow: 0 0 0 2px rgba(76, 110, 245, 0.1);
        }

        .no-results {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        /* Category Tabs */
        .category-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .category-tab {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-tab.active {
            background: #4c6ef5;
            color: white;
            border-color: #4c6ef5;
        }

        .category-tab:hover {
            background: #f3f4f6;
        }

        .category-tab.active:hover {
            background: #3b82f6;
        }

        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-button {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-button:hover {
            background: #f3f4f6;
        }

        .filter-button.active {
            background: #4c6ef5;
            color: white;
            border-color: #4c6ef5;
        }

        .filter-button.active:hover {
            background: #3b82f6;
        }

        .sort-icon {
            font-size: 0.875rem;
        }

        .sort-icon.asc {
            transform: rotate(180deg);
        }

        /* Ranked List Styles */
        .ranked-list {
            margin-top: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .ranked-list-header {
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ranked-list-title {
            font-weight: 600;
            color: #1f2937;
        }

        .ranked-list-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .ranked-item {
            display: grid;
            grid-template-columns: 40px 1fr 1fr 1fr 1fr;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            align-items: center;
        }

        .ranked-item:last-child {
            border-bottom: none;
        }

        .rank-number {
            font-weight: 600;
            color: #4c6ef5;
            text-align: center;
        }

        .rank-agent-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .rank-agent-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .rank-agent-details {
            display: flex;
            flex-direction: column;
        }

        .rank-agent-name {
            font-weight: 500;
            color: #1f2937;
        }

        .rank-agent-position {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .rank-value {
            font-weight: 600;
            color: #1f2937;
        }

        .rank-value.better {
            color: #059669;
        }

        .rank-value.worse {
            color: #dc2626;
        }

        .staff-category-btn {
            padding: 8px 16px;
            border: 1px solid #4c6ef5;
            border-radius: 20px;
            background: white;
            color: #4c6ef5;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .staff-category-btn:hover {
            background: #f0f7ff;
        }

        .staff-category-btn.active {
            background: #4c6ef5;
            color: white;
        }

        .staff-grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .staff-member {
            display: block;
        }

        .staff-member.hidden {
            display: none;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCPGzKsZchYfWG7uYpa3ZYJgUCYS0c9_fU"></script>
</head>
<body>
    <div class="header">
        <h1>Melbourne Real Estate Agencies</h1>
        <p>Comprehensive rental market data and agent information</p>
    </div>

    <button class="compare-button" onclick="openCompareModal(); return false;">Compare Agents</button>

    <div style="position: relative;">
        <div class="filter-container">
            <select class="suburb-select" id="suburb-filter" onchange="filterAgencies()">
                <option value="all">All Suburbs</option>
                <option value="South Yarra">South Yarra</option>
                <option value="Melbourne">Melbourne</option>
                <option value="Toorak">Toorak</option>
            </select>
        </div>
        <div id="map">
            <div id="comparisonOverlay" class="comparison-overlay">
                <div class="comparison-header">
                    <h2>Compare Agents</h2>
                    <button class="modal-close" onclick="closeCompareModal()">&times;</button>
                </div>
                <div class="comparison-content">
                    <div class="toggle-container">
                        <div class="toggle-switch">
                            <div class="toggle-option active" data-type="sales">Sales Agent</div>
                            <div class="toggle-option" data-type="property">Property Manager</div>
                        </div>
                    </div>

                    <div class="comparison-container">
                        <div class="agent-selector">
                            <h3>Select First Agent</h3>
                            <div class="search-container">
                                <input type="text" 
                                       class="search-input" 
                                       id="firstAgentSearch" 
                                       placeholder="Search by name or position...">
                            </div>
                            <div class="agent-list" id="firstAgentList"></div>
                        </div>
                        <div class="agent-selector">
                            <h3>Select Second Agent</h3>
                            <div class="search-container">
                                <input type="text" 
                                       class="search-input" 
                                       id="secondAgentSearch" 
                                       placeholder="Search by name or position...">
                            </div>
                            <div class="agent-list" id="secondAgentList"></div>
                        </div>
                    </div>

                    <div class="comparison-stats" id="comparisonStats"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="agency-cards" id="agency-list"></div>

    <div class="modal-backdrop" id="modal-backdrop"></div>
    <div class="staff-modal" id="staff-modal"></div>

    <!-- Compare Agents Modal -->
    <div id="compareModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCompareModal()">&times;</button>
            <h2>Compare Agents</h2>
            
            <div class="category-tabs">
                <div class="category-tab active" onclick="switchCategory('sales')">Sales Agents</div>
                <div class="category-tab" onclick="switchCategory('property')">Property Managers</div>
            </div>

            <div class="filter-buttons">
                <button class="filter-button" onclick="sortAgents('medianSoldPrice')">
                    Median Sold Price
                    <span class="sort-icon">↓</span>
                </button>
                <button class="filter-button" onclick="sortAgents('medianDaysAdvertised')">
                    Days Advertised
                    <span class="sort-icon">↓</span>
                </button>
                <button class="filter-button" onclick="sortAgents('propertiesSoldLead')">
                    Properties Sold (Lead)
                    <span class="sort-icon">↓</span>
                </button>
                <button class="filter-button" onclick="sortAgents('propertiesSoldSecondary')">
                    Properties Sold (Secondary)
                    <span class="sort-icon">↓</span>
                </button>
            </div>

            <div class="compare-container">
                <div class="agent-selector">
                    <h3>Select First Agent</h3>
                    <div class="search-container">
                        <input type="text" id="firstAgentSearch" class="search-input" placeholder="Search agents...">
                    </div>
                    <div id="firstAgentList" class="agent-list"></div>
                </div>

                <div class="agent-selector">
                    <h3>Select Second Agent</h3>
                    <div class="search-container">
                        <input type="text" id="secondAgentSearch" class="search-input" placeholder="Search agents...">
                    </div>
                    <div id="secondAgentList" class="agent-list"></div>
                </div>
            </div>

            <div id="comparisonStats" class="comparison-stats" style="display: none;">
                <h3>Performance Comparison</h3>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-title">Median Sold Price</div>
                        <div class="stat-value" id="price1"></div>
                        <div class="difference-indicator" id="priceDiff"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Median Days Advertised</div>
                        <div class="stat-value" id="days1"></div>
                        <div class="difference-indicator" id="daysDiff"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Properties Sold (Lead)</div>
                        <div class="stat-value" id="lead1"></div>
                        <div class="difference-indicator" id="leadDiff"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Properties Sold (Secondary)</div>
                        <div class="stat-value" id="secondary1"></div>
                        <div class="difference-indicator" id="secondaryDiff"></div>
                    </div>
                </div>
            </div>

            <div id="rankedList" class="ranked-list" style="display: none;">
                <div class="ranked-list-header">
                    <div class="ranked-list-title">All Agents Performance</div>
                    <button class="modal-close" onclick="closeRankedList()">&times;</button>
                </div>
                <div class="ranked-list-content" id="rankedListContent"></div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let currentInfoWindow = null;
        let allAgencies = [];
        let currentCategory = 'sales';

        function getStarRating(rating) {
            const fullStar = '★';
            const emptyStar = '☆';
            const stars = Math.round(rating);
            return fullStar.repeat(stars) + emptyStar.repeat(5 - stars);
        }

        function getSuburbFromAddress(address) {
            // Handle South Yarra addresses specifically
            if (address.toLowerCase().includes('south yarra')) {
                return 'South Yarra';
            }
            
            const parts = address.split(',');
            for (let part of parts) {
                part = part.trim();
                if (part.includes('VIC')) {
                    return part.split('VIC')[0].trim();
                }
            }
            return '';
        }

        function initMap() {
            // Center point between Melbourne CBD and Toorak (weighted average of all locations)
            const center = { lat: -37.825, lng: 144.985 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,  // Adjusted zoom level to show all locations clearly
                center: center,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    position: google.maps.ControlPosition.TOP_RIGHT
                },
                streetViewControl: true,
                streetViewControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                },
                fullscreenControl: true,
                fullscreenControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_TOP
                },
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_CENTER
                }
            });

            loadAgencies();
        }

        function loadAgencies() {
            fetch('/api/agencies')
                .then(response => response.json())
                .then(agencies => {
                    allAgencies = agencies; // Store all agencies
                    displayAgencies(agencies);
                })
                .catch(error => {
                    console.error('Error loading agencies:', error);
                });
        }

        function filterAgencies() {
            const selectedSuburb = document.getElementById('suburb-filter').value;
            
            // Clear existing markers
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // Filter agencies
            const filteredAgencies = selectedSuburb === 'all' 
                ? allAgencies 
                : allAgencies.filter(agency => getSuburbFromAddress(agency.address) === selectedSuburb);

            // Update map bounds
            if (filteredAgencies.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                filteredAgencies.forEach(agency => {
                    bounds.extend({ lat: agency.lat, lng: agency.lng });
                });
                map.fitBounds(bounds);
                
                // If only one agency, zoom in closer
                if (filteredAgencies.length === 1) {
                    map.setZoom(16);
                }
            }

            // Display filtered agencies
            displayAgencies(filteredAgencies);
        }

        function displayAgencies(agencies) {
            const agencyList = document.getElementById('agency-list');
            agencyList.innerHTML = '';

            // Create bounds object to fit all markers
            const bounds = new google.maps.LatLngBounds();

            agencies.forEach(agency => {
                // Create marker with custom styling
                const position = { lat: agency.lat, lng: agency.lng };
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: agency.name,
                    animation: google.maps.Animation.DROP,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: '#4c6ef5',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });
                
                // Extend bounds to include this marker
                bounds.extend(position);
                markers.push(marker);

                // Create info window content
                const infoContent = `
                    <div style="padding: 25px; max-width: ${agency.name === 'Woodards' ? '80vw' : '400px'}; width: ${agency.name === 'Woodards' ? '80vw' : 'auto'};">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <h2 style="margin: 0 0 15px 0; color: #4c6ef5; font-size: 24px;">${agency.name}</h2>
                            <button onclick="closeInfoWindow()" style="border: none; background: none; cursor: pointer; font-size: 24px; color: #666;">×</button>
                        </div>
                        <p style="margin: 5px 0; color: #666; font-size: 16px;">${agency.address}</p>
                        ${agency.phone ? `<p style="margin: 5px 0; color: #4c6ef5; font-size: 16px;">${agency.phone}</p>` : ''}
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Median Lease</div>
                                <div style="font-size: 20px; font-weight: bold; color: #4c6ef5;">$${agency.medianLeasePrice}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Days Listed</div>
                                <div style="font-size: 20px; font-weight: bold; color: #4c6ef5;">${agency.medianDaysAdvertised}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Properties Leased</div>
                                <div style="font-size: 20px; font-weight: bold; color: #4c6ef5;">${agency.propertiesLeased}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Available Now</div>
                                <div style="font-size: 20px; font-weight: bold; color: #4c6ef5;">${agency.propertiesForRent}</div>
                            </div>
                        </div>

                        ${agency.staff ? `
                        <div style="margin-top: 25px; border-top: 1px solid #eee; padding-top: 25px;">
                            <h3 style="margin: 0 0 20px 0; color: #333; font-size: 20px;">Our Team</h3>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                                <button onclick="toggleStaffCategory(this, 'all', '${agency.name}')" 
                                        class="staff-category-btn active" 
                                        data-category="all">
                                    All Staff
                                </button>
                                <button onclick="toggleStaffCategory(this, 'sales', '${agency.name}')" 
                                        class="staff-category-btn" 
                                        data-category="sales">
                                    Sales Agents
                                </button>
                                <button onclick="toggleStaffCategory(this, 'property', '${agency.name}')" 
                                        class="staff-category-btn" 
                                        data-category="property">
                                    Property Managers
                                </button>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                ${agency.staff.map(member => {
                                    // Determine staff category based on position
                                    let category = 'other';
                                    const position = member.position.toLowerCase();
                                    if (position.includes('sales') || position.includes('principal') || position.includes('director')) {
                                        category = 'sales';
                                    } else if (position.includes('property')) {
                                        category = 'property';
                                    }
                                    return `
                                        <div class="staff-member" data-category="${category}">
                                            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; cursor: pointer; transition: transform 0.2s;" 
                                                 onclick="showStaffModal(${JSON.stringify(member).replace(/"/g, '&quot;')})">
                                                <div style="width: 100px; height: 100px; background: #e0e0e0; border-radius: 50%; margin: 0 auto 15px auto; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                                    ${member.photo ? 
                                                        `<img src="${member.photo}" alt="${member.name}" style="width: 100%; height: 100%; object-fit: cover;"
                                                            onerror="console.error('Failed to load image:', this.src); this.onerror=null; this.src='/images/placeholder.jpg';">` :
                                                        `<span style="color: #999;">Photo</span>`
                                                    }
                                                </div>
                                                <div style="text-align: center;">
                                                    <div style="font-weight: bold; color: #4c6ef5; margin-bottom: 8px; font-size: 16px;">${member.name}</div>
                                                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">${member.position}</div>
                                                    <div style="font-size: 14px; color: #4c6ef5;">${member.phone}</div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

                const infoWindow = new google.maps.InfoWindow({
                    content: infoContent,
                    maxWidth: agency.name === 'Woodards' ? 1200 : 400
                });

                marker.addListener('click', () => {
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }
                    infoWindow.open(map, marker);
                    currentInfoWindow = infoWindow;
                });

                // Create agency card
                const card = document.createElement('div');
                card.className = 'agency-card';
                card.innerHTML = `
                    <div class="agency-name">${agency.name}</div>
                    <div class="agency-address">${agency.address}</div>
                    ${agency.phone ? `<div class="agency-phone">${agency.phone}</div>` : ''}
                    
                    <div class="agency-stats">
                        <div class="stat-item">
                            <span class="stat-label">Median Lease</span>
                            <span class="stat-value">$${agency.medianLeasePrice}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Days Listed</span>
                            <span class="stat-value">${agency.medianDaysAdvertised}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Properties Leased</span>
                            <span class="stat-value">${agency.propertiesLeased}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Available Now</span>
                            <span class="stat-value">${agency.propertiesForRent}</span>
                        </div>
                    </div>

                    ${agency.staff ? `
                    <div class="staff-section">
                        <h3 style="margin: 0 0 15px 0; color: #333; font-size: 18px;">Our Team</h3>
                        <div class="staff-grid">
                            ${agency.staff.map(member => `
                                <div class="staff-item" onclick="showStaffModal(${JSON.stringify(member).replace(/"/g, '&quot;')})">
                                    <div style="font-weight: bold; color: #4c6ef5; margin-bottom: 4px;">${member.name}</div>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">${member.position}</div>
                                    <div style="font-size: 12px; color: #4c6ef5;">${member.phone}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                `;

                card.addEventListener('click', () => {
                    map.setCenter(position);
                    map.setZoom(16);
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }
                    infoWindow.open(map, marker);
                    currentInfoWindow = infoWindow;
                });

                agencyList.appendChild(card);
            });

            // Fit map to show all markers with padding
            map.fitBounds(bounds, { 
                padding: {
                    top: 50,
                    right: 50,
                    bottom: 50,
                    left: 50
                }
            });

            // Set minimum zoom level to ensure good visibility
            const listener = google.maps.event.addListener(map, 'idle', function() {
                if (map.getZoom() > 14) {
                    map.setZoom(14);
                }
                google.maps.event.removeListener(listener);
            });
        }

        function toggleReviews(button, agencyId) {
            const reviewsList = document.querySelector(`.reviews-list[data-agency="${agencyId}"]`);
            if (reviewsList.style.display === 'none') {
                reviewsList.style.display = 'block';
                button.textContent = 'Hide Reviews';
            } else {
                reviewsList.style.display = 'none';
                button.textContent = 'Show Reviews';
            }
        }

        function toggleStaff(button, agencyId) {
            const staffList = document.querySelector(`.staff-list[data-agency="${agencyId}"]`);
            if (staffList.style.display === 'none' || !staffList.style.display) {
                staffList.style.display = 'block';
                button.textContent = 'Hide Staff';
            } else {
                staffList.style.display = 'none';
                button.textContent = 'Show Staff';
            }
        }

        function closeInfoWindow() {
            if (currentInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        }

        function showStaffModal(member) {
            console.log('Opening modal for:', member);
            console.log('Photo path:', member.photo);
            
            const modal = document.getElementById('staff-modal');
            const backdrop = document.getElementById('modal-backdrop');
            
            modal.innerHTML = `
                <div class="staff-modal-header">
                    <button class="staff-modal-close" onclick="closeStaffModal()">×</button>
                </div>
                <div class="staff-modal-content">
                    <div class="staff-modal-photo">
                        ${member.photo ? 
                            `<img src="${member.photo}" alt="${member.name}" 
                                onerror="console.error('Failed to load image:', this.src); this.onerror=null; this.src='/images/placeholder.jpg';">` :
                            `<span style="color: #999;">Photo</span>`
                        }
                    </div>
                    <div class="staff-modal-info">
                        <div class="staff-modal-name">${member.name}</div>
                        <div class="staff-modal-position">${member.title}</div>
                        <div class="staff-modal-phone">${member.phone}</div>
                        
                        ${member.performance ? `
                        <div class="performance-grid">
                            <div class="performance-item">
                                <div class="performance-value">${member.performance.medianSoldPrice}</div>
                                <div class="performance-label">Median Sold Price</div>
                            </div>
                            <div class="performance-item">
                                <div class="performance-value">${member.performance.medianDaysAdvertised}</div>
                                <div class="performance-label">Median Days Advertised</div>
                            </div>
                            <div class="performance-item">
                                <div class="performance-value">${member.performance.propertiesSoldLead}</div>
                                <div class="performance-label">Properties Sold (Lead)</div>
                            </div>
                            <div class="performance-item">
                                <div class="performance-value">${member.performance.propertiesSoldSecondary}</div>
                                <div class="performance-label">Properties Sold (Secondary)</div>
                            </div>
                        </div>
                        ` : ''}

                        <button onclick="showComparisonInModal(${JSON.stringify(member).replace(/"/g, '&quot;')})" 
                                style="margin-top: 20px; padding: 10px 20px; background: #4c6ef5; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.2s;">
                            Compare with Other Agents
                        </button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            backdrop.style.display = 'block';
        }

        function showComparisonInModal(selectedMember) {
            const modal = document.getElementById('staff-modal');
            const backdrop = document.getElementById('modal-backdrop');
            
            // Get all agents from all agencies
            const allAgents = allAgencies.flatMap(agency => 
                agency.agents.map(agent => ({
                    ...agent,
                    agency: agency.name
                }))
            );

            // Filter agents by the same category as the selected member
            const position = selectedMember.position.toLowerCase();
            const category = position.includes('sales') || position.includes('principal') || position.includes('director') ? 'sales' : 'property';
            
            const filteredAgents = allAgents.filter(agent => {
                const agentPosition = agent.position.toLowerCase();
                return category === 'sales' ? 
                    (agentPosition.includes('sales') || agentPosition.includes('principal') || agentPosition.includes('director')) : 
                    agentPosition.includes('property manager');
            });

            // Remove the selected agent from the list
            const otherAgents = filteredAgents.filter(agent => 
                agent.name !== selectedMember.name || agent.agency !== selectedMember.agency
            );

            modal.innerHTML = `
                <div class="staff-modal-header">
                    <button class="staff-modal-close" onclick="closeStaffModal()">×</button>
                </div>
                <div class="staff-modal-content" style="max-width: 800px; width: 100%;">
                    <h2 style="margin-bottom: 20px; color: #333;">Compare Agents</h2>
                    
                    <div class="category-tabs">
                        <div class="category-tab ${category === 'sales' ? 'active' : ''}" onclick="switchCategoryInModal('sales')">Sales Agents</div>
                        <div class="category-tab ${category === 'property' ? 'active' : ''}" onclick="switchCategoryInModal('property')">Property Managers</div>
                    </div>

                    <div class="filter-buttons">
                        ${category === 'sales' ? `
                            <button class="filter-button" onclick="sortAgentsInModal('medianSoldPrice')">
                                Median Sold Price
                                <span class="sort-icon">↓</span>
                            </button>
                            <button class="filter-button" onclick="sortAgentsInModal('medianDaysAdvertised')">
                                Days Advertised
                                <span class="sort-icon">↓</span>
                            </button>
                            <button class="filter-button" onclick="sortAgentsInModal('propertiesSoldLead')">
                                Properties Sold (Lead)
                                <span class="sort-icon">↓</span>
                            </button>
                            <button class="filter-button" onclick="sortAgentsInModal('propertiesSoldSecondary')">
                                Properties Sold (Secondary)
                                <span class="sort-icon">↓</span>
                            </button>
                        ` : `
                            <button class="filter-button" onclick="sortAgentsInModal('propertiesLeased')">
                                Properties Leased
                                <span class="sort-icon">↓</span>
                            </button>
                        `}
                    </div>

                    <div class="compare-container">
                        <div class="agent-selector">
                            <h3>Selected Agent</h3>
                            <div class="agent-list">
                                <div class="agent-item selected">
                                    <img src="${selectedMember.photo}" alt="${selectedMember.name}" onerror="this.src='https://via.placeholder.com/40'">
                                    <div class="agent-info">
                                        <div class="agent-name">${selectedMember.name}</div>
                                        <div class="agent-details">${selectedMember.position} at ${selectedMember.agency}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="agent-selector">
                            <h3>Compare With</h3>
                            <div class="search-container">
                                <input type="text" class="search-input" placeholder="Search agents..." oninput="filterAgentsInModal(this.value)">
                            </div>
                            <div class="agent-list" id="compareAgentList">
                                ${otherAgents.map(agent => `
                                    <div class="agent-item" onclick="selectAgentForComparison(${JSON.stringify(agent).replace(/"/g, '&quot;')})">
                                        <img src="${agent.photo}" alt="${agent.name}" onerror="this.src='https://via.placeholder.com/40'">
                                        <div class="agent-info">
                                            <div class="agent-name">${agent.name}</div>
                                            <div class="agent-details">${agent.position} at ${agent.agency}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div id="comparisonStats" class="comparison-stats" style="display: none;">
                        <h3>Performance Comparison</h3>
                        <div class="stat-grid">
                            ${category === 'sales' ? `
                                <div class="stat-card">
                                    <div class="stat-title">Median Sold Price</div>
                                    <div class="stat-value" id="price1"></div>
                                    <div class="difference-indicator" id="priceDiff"></div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-title">Median Days Advertised</div>
                                    <div class="stat-value" id="days1"></div>
                                    <div class="difference-indicator" id="daysDiff"></div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-title">Properties Sold (Lead)</div>
                                    <div class="stat-value" id="lead1"></div>
                                    <div class="difference-indicator" id="leadDiff"></div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-title">Properties Sold (Secondary)</div>
                                    <div class="stat-value" id="secondary1"></div>
                                    <div class="difference-indicator" id="secondaryDiff"></div>
                                </div>
                            ` : `
                                <div class="stat-card">
                                    <div class="stat-title">Properties Leased</div>
                                    <div class="stat-value" id="leased1"></div>
                                    <div class="difference-indicator" id="leasedDiff"></div>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function filterAgentsInModal(searchTerm) {
            const agentList = document.getElementById('compareAgentList');
            const items = agentList.querySelectorAll('.agent-item');
            
            items.forEach(item => {
                const name = item.querySelector('.agent-name').textContent.toLowerCase();
                const position = item.querySelector('.agent-details').textContent.toLowerCase();
                const matches = name.includes(searchTerm.toLowerCase()) || position.includes(searchTerm.toLowerCase());
                item.style.display = matches ? 'flex' : 'none';
            });
        }

        function selectAgentForComparison(agent) {
            const agentList = document.getElementById('compareAgentList');
            agentList.querySelectorAll('.agent-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            updateComparisonStatsInModal(agent);
        }

        function updateComparisonStatsInModal(selectedAgent) {
            const selectedMember = JSON.parse(event.currentTarget.getAttribute('data-member'));
            document.getElementById('comparisonStats').style.display = 'block';

            const position = selectedMember.position.toLowerCase();
            const category = position.includes('sales') || position.includes('principal') || position.includes('director') ? 'sales' : 'property';

            if (category === 'sales') {
                // Update values for the selected member (sales agent)
                document.getElementById('price1').textContent = `$${selectedMember.performance.medianSoldPrice.toLocaleString()}`;
                document.getElementById('days1').textContent = selectedMember.performance.medianDaysAdvertised;
                document.getElementById('lead1').textContent = selectedMember.performance.propertiesSoldLead;
                document.getElementById('secondary1').textContent = selectedMember.performance.propertiesSoldSecondary;

                // Calculate and display differences
                updateDifference('priceDiff', selectedMember.performance.medianSoldPrice, selectedAgent.performance.medianSoldPrice, true);
                updateDifference('daysDiff', selectedMember.performance.medianDaysAdvertised, selectedAgent.performance.medianDaysAdvertised, false);
                updateDifference('leadDiff', selectedMember.performance.propertiesSoldLead, selectedAgent.performance.propertiesSoldLead, true);
                updateDifference('secondaryDiff', selectedMember.performance.propertiesSoldSecondary, selectedAgent.performance.propertiesSoldSecondary, true);
            } else {
                // Update values for the selected member (property manager)
                document.getElementById('leased1').textContent = selectedMember.performance.propertiesLeased;

                // Calculate and display differences
                updateDifference('leasedDiff', selectedMember.performance.propertiesLeased, selectedAgent.performance.propertiesLeased, true);
            }
        }

        function switchCategoryInModal(category) {
            const tabs = document.querySelectorAll('.category-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(category)) {
                    tab.classList.add('active');
                }
            });

            // Get all agents from all agencies
            const allAgents = allAgencies.flatMap(agency => 
                agency.agents.map(agent => ({
                    ...agent,
                    agency: agency.name
                }))
            );

            // Filter agents by category
            const filteredAgents = allAgents.filter(agent => 
                category === 'sales' ? 
                    (agent.position.toLowerCase().includes('sales') || agent.position.toLowerCase().includes('principal') || agent.position.toLowerCase().includes('director')) : 
                    agent.position.toLowerCase().includes('property manager')
            );

            // Update the compare agent list
            const agentList = document.getElementById('compareAgentList');
            agentList.innerHTML = filteredAgents.map(agent => `
                <div class="agent-item" onclick="selectAgentForComparison(${JSON.stringify(agent).replace(/"/g, '&quot;')})">
                    <img src="${agent.photo}" alt="${agent.name}" onerror="this.src='https://via.placeholder.com/40'">
                    <div class="agent-info">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-details">${agent.position} at ${agent.agency}</div>
                    </div>
                </div>
            `).join('');
        }

        function sortAgentsInModal(metric) {
            const button = event.currentTarget;
            const icon = button.querySelector('.sort-icon');
            const isAscending = !button.classList.contains('active') || icon.classList.contains('asc');
            
            // Update button state
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
                btn.querySelector('.sort-icon').classList.remove('asc');
            });
            
            button.classList.add('active');
            icon.classList.toggle('asc', isAscending);
            
            // Get all agents from the compare list
            const agentList = document.getElementById('compareAgentList');
            const agents = Array.from(agentList.querySelectorAll('.agent-item')).map(item => 
                JSON.parse(item.getAttribute('data-member'))
            );
            
            // Sort agents
            agents.sort((a, b) => {
                const valueA = a.performance[metric];
                const valueB = b.performance[metric];
                return isAscending ? valueA - valueB : valueB - valueA;
            });
            
            // Update the list
            agentList.innerHTML = agents.map(agent => `
                <div class="agent-item" onclick="selectAgentForComparison(${JSON.stringify(agent).replace(/"/g, '&quot;')})">
                    <img src="${agent.photo}" alt="${agent.name}" onerror="this.src='https://via.placeholder.com/40'">
                    <div class="agent-info">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-details">${agent.position} at ${agent.agency}</div>
                    </div>
                </div>
            `).join('');
        }

        function closeStaffModal() {
            const modal = document.getElementById('staff-modal');
            const backdrop = document.getElementById('modal-backdrop');
            modal.style.display = 'none';
            backdrop.style.display = 'none';
        }

        function openCompareModal() {
            document.getElementById('compareModal').style.display = 'block';
            initComparison();
        }

        function closeCompareModal() {
            document.getElementById('compareModal').style.display = 'none';
        }

        function switchCategory(category) {
            currentCategory = category;
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent.toLowerCase().includes(category)) {
                    tab.classList.add('active');
                }
            });

            // Get all agents from all agencies
            const allAgents = allAgencies.flatMap(agency => 
                agency.agents.map(agent => ({
                    ...agent,
                    agency: agency.name
                }))
            );

            // Filter agents by category
            const filteredAgents = allAgents.filter(agent => 
                category === 'sales' ? 
                    agent.position.toLowerCase().includes('sales') : 
                    agent.position.toLowerCase().includes('property manager')
            );

            // Clear previous selections
            document.getElementById('firstAgentList').innerHTML = '';
            document.getElementById('secondAgentList').innerHTML = '';
            document.getElementById('comparisonStats').style.display = 'none';
            document.getElementById('rankedList').style.display = 'none';

            // Render agent lists
            renderAgentList('firstAgentList', filteredAgents, 'firstAgent');
            renderAgentList('secondAgentList', filteredAgents, 'secondAgent');

            // Reset search inputs
            document.getElementById('firstAgentSearch').value = '';
            document.getElementById('secondAgentSearch').value = '';

            // Reset filter buttons
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
                btn.querySelector('.sort-icon').classList.remove('asc');
            });
        }

        function renderAgentList(listId, agents, agentPrefix) {
            const list = document.getElementById(listId);
            list.innerHTML = '';

            if (agents.length === 0) {
                list.innerHTML = '<div class="no-results">No agents found</div>';
                return;
            }

            agents.forEach(agent => {
                const item = document.createElement('div');
                item.className = 'agent-item';
                item.innerHTML = `
                    <img src="${agent.photo}" alt="${agent.name}" onerror="this.src='https://via.placeholder.com/40'">
                    <div class="agent-info">
                        <div class="agent-name">${agent.name}</div>
                        <div class="agent-details">${agent.position} at ${agent.agency}</div>
                        <div class="agent-performance">
                            <span>Median Price: $${agent.performance.medianSoldPrice.toLocaleString()}</span>
                            <span>Days: ${agent.performance.medianDaysAdvertised}</span>
                            <span>Lead: ${agent.performance.propertiesSoldLead}</span>
                        </div>
                    </div>
                `;
                item.onclick = () => selectAgent(agent, agentPrefix);
                list.appendChild(item);
            });
        }

        function selectAgent(agent, prefix) {
            // Remove selection from other items in the same list
            const list = document.getElementById(`${prefix}List`);
            list.querySelectorAll('.agent-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selection to clicked item
            event.currentTarget.classList.add('selected');

            // Update comparison stats if both agents are selected
            const firstAgent = document.querySelector('#firstAgentList .selected');
            const secondAgent = document.querySelector('#secondAgentList .selected');

            if (firstAgent && secondAgent) {
                updateComparisonStats();
            }
        }

        function updateComparisonStats() {
            const firstAgent = getSelectedAgentData('firstAgentList');
            const secondAgent = getSelectedAgentData('secondAgentList');

            if (!firstAgent || !secondAgent) return;

            // Show comparison stats
            document.getElementById('comparisonStats').style.display = 'block';

            // Update values
            document.getElementById('price1').textContent = `$${firstAgent.performance.medianSoldPrice.toLocaleString()}`;
            document.getElementById('days1').textContent = firstAgent.performance.medianDaysAdvertised;
            document.getElementById('lead1').textContent = firstAgent.performance.propertiesSoldLead;
            document.getElementById('secondary1').textContent = firstAgent.performance.propertiesSoldSecondary;

            // Calculate and display differences
            updateDifference('priceDiff', firstAgent.performance.medianSoldPrice, secondAgent.performance.medianSoldPrice, true);
            updateDifference('daysDiff', firstAgent.performance.medianDaysAdvertised, secondAgent.performance.medianDaysAdvertised, false);
            updateDifference('leadDiff', firstAgent.performance.propertiesSoldLead, secondAgent.performance.propertiesSoldLead, true);
            updateDifference('secondaryDiff', firstAgent.performance.propertiesSoldSecondary, secondAgent.performance.propertiesSoldSecondary, true);
        }

        function getSelectedAgentData(listId) {
            const selectedItem = document.querySelector(`#${listId} .selected`);
            if (!selectedItem) return null;

            const agentName = selectedItem.querySelector('.agent-name').textContent;
            const agentDetails = selectedItem.querySelector('.agent-details').textContent;
            const [position, agency] = agentDetails.split(' at ');

            return allAgencies
                .find(a => a.name === agency)
                ?.agents.find(a => a.name === agentName);
        }

        function updateDifference(elementId, value1, value2, higherIsBetter) {
            const diff = value1 - value2;
            const element = document.getElementById(elementId);
            const arrow = diff > 0 ? '↑' : '↓';
            const color = (diff > 0 && higherIsBetter) || (diff < 0 && !higherIsBetter) ? 'better' : 'worse';
            
            element.innerHTML = `
                <span class="${color}">${arrow}</span>
                <span class="difference-value ${color}">${formatDifference(diff, higherIsBetter)}</span>
            `;
        }

        function formatDifference(diff, higherIsBetter) {
            if (higherIsBetter) {
                return diff > 0 ? `+${diff.toLocaleString()}` : diff.toLocaleString();
            } else {
                return diff < 0 ? `+${Math.abs(diff).toLocaleString()}` : `-${diff.toLocaleString()}`;
            }
        }

        function sortAgents(metric) {
            const button = event.currentTarget;
            const icon = button.querySelector('.sort-icon');
            const isAscending = !button.classList.contains('active') || icon.classList.contains('asc');
            
            // Update button state
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
                btn.querySelector('.sort-icon').classList.remove('asc');
            });
            
            button.classList.add('active');
            icon.classList.toggle('asc', isAscending);
            
            // Get all agents from all agencies
            const allAgents = allAgencies.flatMap(agency => 
                agency.agents.map(agent => ({
                    ...agent,
                    agency: agency.name
                }))
            );

            // Filter for sales agents only
            const salesAgents = allAgents.filter(agent => 
                agent.position.toLowerCase().includes('sales')
            );
            
            // Sort agents
            salesAgents.sort((a, b) => {
                const valueA = a.performance[metric];
                const valueB = b.performance[metric];
                return isAscending ? valueA - valueB : valueB - valueA;
            });
            
            // Show ranked list
            showRankedList(salesAgents, metric, isAscending);
        }

        function showRankedList(agents, metric, isAscending) {
            const rankedList = document.getElementById('rankedList');
            const rankedListContent = document.getElementById('rankedListContent');
            const metricLabels = {
                medianSoldPrice: 'Median Sold Price',
                medianDaysAdvertised: 'Days Advertised',
                propertiesSoldLead: 'Properties Sold (Lead)',
                propertiesSoldSecondary: 'Properties Sold (Secondary)'
            };

            rankedListContent.innerHTML = agents.map((agent, index) => {
                const value = agent.performance[metric];
                const formattedValue = metric === 'medianSoldPrice' 
                    ? `$${value.toLocaleString()}`
                    : value.toLocaleString();

                return `
                    <div class="ranked-item">
                        <div class="rank-number">${index + 1}</div>
                        <div class="rank-agent-info">
                            <img src="${agent.photo}" alt="${agent.name}" class="rank-agent-photo" 
                                 onerror="this.src='https://via.placeholder.com/40'">
                            <div class="rank-agent-details">
                                <div class="rank-agent-name">${agent.name}</div>
                                <div class="rank-agent-position">${agent.position} at ${agent.agency}</div>
                            </div>
                        </div>
                        <div class="rank-value">${formattedValue}</div>
                        <div class="rank-value">${agent.performance.medianDaysAdvertised} days</div>
                        <div class="rank-value">${agent.performance.propertiesSoldLead}</div>
                    </div>
                `;
            }).join('');

            rankedList.style.display = 'block';
        }

        function closeRankedList() {
            document.getElementById('rankedList').style.display = 'none';
            document.querySelectorAll('.filter-button').forEach(btn => {
                btn.classList.remove('active');
                btn.querySelector('.sort-icon').classList.remove('asc');
            });
        }

        function toggleStaffCategory(button, category, agencyName) {
            // Update button styles
            const buttons = button.parentElement.querySelectorAll('.staff-category-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            // Show/hide staff members
            const staffMembers = button.closest('div').nextElementSibling.querySelectorAll('.staff-member');
            staffMembers.forEach(member => {
                if (category === 'all') {
                    member.style.display = 'block';
                } else {
                    member.style.display = member.dataset.category === category ? 'block' : 'none';
                }
            });
        }

        // Initialize the map
        initMap();
    </script>
</body>
</html>